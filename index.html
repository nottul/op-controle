<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contr√¥les OP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; height: 100vh; }
    .hidden { display: none !important; }
    .status-badge {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-new { background-color: #6b7280; }
    .status-pending { background-color: #f59e0b; }
    .status-done { background-color: #10b981; }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .qty-btn {
      width: 30px;
      height: 30px;
      font-size: 18px;
      font-weight: bold;
      background-color: #e5e7eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- √âcran de chargement -->
  <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg flex flex-col items-center">
      <div class="spinner mb-4"></div>
      <p class="text-gray-700">Chargement en cours...</p>
    </div>
  </div>

  <!-- √âcran de connexion -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md w-80 text-center">
      <h1 class="text-2xl font-bold mb-6 text-blue-600">Contr√¥les OP</h1>
      <form id="loginForm" class="space-y-4">
        <input id="email" type="text" placeholder="Identifiant" class="w-full p-2 border rounded" required>
        <input id="password" type="password" placeholder="Mot de passe" class="w-full p-2 border rounded" required>
        <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded">Se connecter</button>
      </form>
      <p id="loginError" class="text-red-500 mt-2 hidden">Identifiant ou mot de passe incorrect</p>
    </div>
  </div>

  <!-- Interface Manager -->
  <div id="managerApp" class="hidden h-screen flex flex-col">
    <header class="bg-white p-4 shadow">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">üìã Contr√¥les - <span id="currentDate"></span></h1>
        <button id="logoutBtn" class="text-red-500">D√©connexion</button>
      </div>
    </header>
    <main class="flex-1 p-4 overflow-auto">
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-4">Mes Employ√©s</h2>
        <div id="employesList" class="space-y-2"></div>
      </div>
    </main>
  </div>

  <!-- Modal de contr√¥le -->
  <div id="controleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Contr√¥le pour <span id="modalEmployeNom"></span></h2>
          <button id="closeModalBtn" class="text-gray-500 text-2xl">&times;</button>
        </div>
        <div id="produitsList" class="space-y-4 mb-6 modal-content"></div>
        <div class="flex space-x-2">
          <button id="validerSansConfirmationBtn" class="flex-1 bg-green-600 text-white py-2 rounded">‚úÖ Valider sans confirmation</button>
          <button id="validerAvecConfirmationBtn" class="flex-1 bg-blue-600 text-white py-2 rounded">üîÑ Valider avec confirmation</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      deployedURL: 'https://script.google.com/macros/s/AKfycbxWEfPlq6KBLE5hwk86e3O6xoaG3m1J8bIV9eu9IlS0AZOqYW2wpTBKJ84TBbH-DORPPw/exec',
      managers: [
        { email: 'thierry', password: '1234', role: 'manager' },
        { email: 'johan', password: '1234', role: 'manager' }
      ]
    };

    // √âtat de l'application
    let currentUser = null;
    let allUsers = [];
    let currentEmploye = null;
    let controles = {};
    let produits = [];

    // Fonctions utilitaires
    function showLoading(show) {
      document.getElementById('loadingSpinner').classList.toggle('hidden', !show);
    }

    function showError(message) {
      const errorElement = document.getElementById('loginError');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat('fr-FR').format(date);
    }

    // Charger les produits depuis le Google Sheet
    async function loadProduits(idEmploye) {
      showLoading(true);
      try {
        console.log(`Chargement des produits pour l'employ√© ID: ${idEmploye}`);
        const response = await fetch(`${CONFIG.deployedURL}?action=getProduits&idEmploye=${idEmploye}`);
        if (!response.ok) throw new Error("Erreur r√©seau");

        const produits = await response.json();
        console.log('R√©ponse brute:', produits);

        if (produits.status === 'error') {
          console.error('Erreur dans la r√©ponse:', produits.message);
          return [];
        }

        if (!Array.isArray(produits)) {
          console.error('Format de r√©ponse inattendu:', produits);
          return [];
        }

        console.log('Produits pars√©s:', JSON.parse(JSON.stringify(produits)));
        return produits;
      } catch (error) {
        console.error("Erreur:", error);
        return [];
      } finally {
        showLoading(false);
      }
    }

    // Ouvrir la modale de contr√¥le
    async function openControleModal(employe) {
      currentEmploye = employe;
      document.getElementById('modalEmployeNom').textContent = `${employe.prenom} ${employe.nom}`;
      document.getElementById('controleModal').classList.remove('hidden');

      console.log('ID Employ√©:', employe.ID_Employ√©);

      produits = await loadProduits(employe.ID_Employ√©);
      console.log('Produits re√ßus:', JSON.parse(JSON.stringify(produits)));

      const produitsList = document.getElementById('produitsList');
      produitsList.innerHTML = '';

      if (!produits || produits.length === 0) {
        console.log('Aucun produit trouv√© pour cet employ√©.');
        produitsList.innerHTML = '<p class="text-gray-500 p-4 text-center">Aucun produit trouv√© pour cet employ√©.</p>';
        return;
      }

      // V√©rification d√©taill√©e de chaque produit
      produits.forEach((produit, index) => {
        console.log('Produit:', index, JSON.parse(JSON.stringify(produit)));
        console.log('Type de produit:', typeof produit);
        console.log('Cl√©s du produit:', Object.keys(produit));

        const produitElement = document.createElement('div');
        produitElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded';

        // V√©rification et affichage s√©curis√© des propri√©t√©s
        const codeProduit = produit.Code_Produit ? produit.Code_Produit : 'Non d√©fini';
        const designation = produit.D√©signation ? produit.D√©signation : 'Produit non d√©fini';
        const qtePrevue = produit['Qt√©_Pr√©vue'] !== undefined ? produit['Qt√©_Pr√©vue'] : 'Non d√©finie';

        produitElement.innerHTML = `
          <span class="font-medium">
            ${codeProduit} - ${designation} (Pr√©vu: ${qtePrevue})
          </span>
          <div class="flex items-center space-x-2">
            <button class="qty-btn minus-btn" data-index="${index}">-</button>
            <span class="qte-display w-8 text-center">0</span>
            <button class="qty-btn plus-btn" data-index="${index}">+</button>
          </div>
        `;
        produitsList.appendChild(produitElement);
      });

      // Ajouter les √©couteurs d'√©v√©nements pour les boutons +/- apr√®s avoir charg√© les produits
      document.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', () => updateQte(btn.dataset.index, -1));
      });
      document.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', () => updateQte(btn.dataset.index, 1));
      });
    }

    // Mettre √† jour la quantit√©
    function updateQte(index, delta) {
      const qteElements = document.querySelectorAll('.qte-display');
      const currentQte = parseInt(qteElements[index].textContent);
      const newQte = Math.max(0, currentQte + delta);
      qteElements[index].textContent = newQte;
    }

    // Fermer la modale
    function closeControleModal() {
      document.getElementById('controleModal').classList.add('hidden');
    }

    // Valider le contr√¥le
    async function validerControle(avecConfirmation) {
      if (!currentEmploye) return;

      const produitsElements = document.querySelectorAll('.qte-display');
      let hasQte = false;
      let allUpdatesSuccessful = true;

      for (let i = 0; i < produits.length; i++) {
        const qteControlee = parseInt(produitsElements[i].textContent);
        if (qteControlee > 0) {
          hasQte = true;
          try {
            const response = await fetch(CONFIG.deployedURL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                ID_Employ√©: currentEmploye.ID_Employ√©,
                Code_Produit: produits[i].Code_Produit,
                Qt√©_Contr√¥l√©e: qteControlee,
              }),
            });

            if (!response.ok) {
              console.error("Erreur lors de l'enregistrement du produit:", produits[i]);
              allUpdatesSuccessful = false;
            }
          } catch (error) {
            console.error("Erreur lors de l'enregistrement:", error);
            allUpdatesSuccessful = false;
          }
        }
      }

      if (!hasQte) {
        alert('Veuillez saisir au moins une quantit√©');
        return;
      }

      if (allUpdatesSuccessful) {
        alert(`Contr√¥le ${avecConfirmation ? 'en attente de validation' : 'valid√©'} avec succ√®s`);
      } else {
        alert(`Contr√¥le ${avecConfirmation ? 'en attente de validation' : 'valid√©'}, mais certaines mises √† jour ont √©chou√©. V√©rifiez les logs pour plus de d√©tails.`);
      }

      closeControleModal();
      loadEmployes();
    }

    // Charger la liste des employ√©s
    function loadEmployes() {
      const listElement = document.getElementById('employesList');
      listElement.innerHTML = '';
      const employes = allUsers.filter(u =>
        u.role === 'employe' && u.manager === currentUser.email
      );

      if (employes.length === 0) {
        listElement.innerHTML = '<p class="text-gray-500">Aucun employ√© trouv√©</p>';
        return;
      }

      employes.forEach(emp => {
        const employeeItem = document.createElement('div');
        employeeItem.className = 'p-3 border rounded-lg bg-white flex justify-between items-center';
        const statut = controles[emp.email] ? 'pending' : 'new';
        employeeItem.innerHTML = `
          <div>
            <span class="status-badge status-${statut}"></span>
            <span>${emp.prenom} ${emp.nom}</span>
          </div>
          <button class="controle-btn bg-blue-500 text-white px-3 py-1 rounded text-sm" data-email="${emp.email}">
            Contr√¥ler
          </button>
        `;
        listElement.appendChild(employeeItem);
      });

      // Ajouter les √©couteurs d'√©v√©nements aux boutons Contr√¥ler
      document.querySelectorAll('.controle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const employeEmail = btn.dataset.email;
          const employe = allUsers.find(u => u.email === employeEmail);
          openControleModal(employe);
        });
      });
    }

    // Gestion de la connexion
    async function login(event) {
      event.preventDefault();
      showLoading(true);
      showError('');
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(`${CONFIG.deployedURL}?action=getEmployes`);
        if (!response.ok) throw new Error('Erreur r√©seau');
        const employesData = await response.json();
        if (!Array.isArray(employesData)) throw new Error('Donn√©es invalides');

        allUsers = [
          ...CONFIG.managers,
          ...employesData.map(emp => ({
            ID_Employ√©: emp.ID_Employ√© || '',
            email: (emp.Email || '').toLowerCase(),
            password: '1234',
            role: 'employe',
            nom: emp.Nom || '',
            prenom: emp.Pr√©nom || '',
            equipe: emp.Equipe || '',
            manager: String(emp.Equipe).includes('1') ? 'thierry' : 'johan'
          }))
        ];

        const user = allUsers.find(u => u.email === email && u.password === password);
        if (!user) {
          showError('Identifiant ou mot de passe incorrect');
          return;
        }

        currentUser = user;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('managerApp').classList.remove('hidden');
        document.getElementById('currentDate').textContent = formatDate(new Date());
        loadEmployes();
      } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur de connexion. V√©rifiez votre connexion internet.');
      } finally {
        showLoading(false);
      }
    }

    // D√©connexion
    function logout() {
      document.getElementById('managerApp').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      currentUser = null;
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginForm').addEventListener('submit', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('closeModalBtn').addEventListener('click', closeControleModal);
      document.getElementById('validerSansConfirmationBtn').addEventListener('click', () => validerControle(false));
      document.getElementById('validerAvecConfirmationBtn').addEventListener('click', () => validerControle(true));
    });
  </script>
</body>
</html>
