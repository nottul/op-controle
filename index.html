<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contr√¥les OP - Personnel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; height: 100vh; }
    .hidden { display: none !important; }
    .status-badge {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-new { background-color: #6b7280; }
    .status-pending { background-color: #f59e0b; }
    .status-done { background-color: #10b981; }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .qty-btn {
      width: 30px;
      height: 30px;
      font-size: 18px;
      font-weight: bold;
      background-color: #e5e7eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }
    .logo-container {
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
    }
    .logo {
      height: 60px;
      width: auto;
    }
    .debug-info {
      background-color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-family: monospace;
      font-size: 0.875rem;
    }
    .error-message {
      color: #ef4444;
      background-color: #fee2e2;
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- √âcran de chargement -->
  <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg flex flex-col items-center">
      <div class="spinner mb-4"></div>
      <p class="text-gray-700">Chargement en cours...</p>
    </div>
  </div>

  <!-- √âcran de connexion -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen bg-gray-50">
    <div class="bg-white p-8 rounded-lg shadow-md w-80 text-center">
      <div class="logo-container">
        <img src="https://via.placeholder.com/150x60?text=Personnel" alt="Logo Personnel" class="logo">
      </div>
      <h1 class="text-2xl font-bold mb-6 text-blue-600">Contr√¥les OP</h1>
      <form id="loginForm" class="space-y-4">
        <input id="email" type="text" placeholder="Identifiant" class="w-full p-2 border rounded" required>
        <input id="password" type="password" placeholder="Mot de passe" class="w-full p-2 border rounded" required>
        <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 transition">Se connecter</button>
      </form>
      <p id="loginError" class="text-red-500 mt-2 hidden"></p>
    </div>
  </div>

  <!-- Interface Manager -->
  <div id="managerApp" class="hidden h-screen flex flex-col">
    <header class="bg-white p-4 shadow">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">üìã Contr√¥les - <span id="currentDate"></span></h1>
        <div>
          <button id="debugBtn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded text-sm mr-2 hover:bg-gray-300 transition">Debug</button>
          <button id="logoutBtn" class="text-red-500 hover:text-red-700 transition">D√©connexion</button>
        </div>
      </div>
    </header>
    <main class="flex-1 p-4 overflow-auto">
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-4">Mes Employ√©s</h2>
        <div id="debugInfo" class="debug-info hidden"></div>
        <div id="employesList" class="space-y-2"></div>
      </div>
    </main>
  </div>

  <!-- Modal de contr√¥le -->
  <div id="controleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Contr√¥le pour <span id="modalEmployeNom"></span></h2>
          <button id="closeModalBtn" class="text-gray-500 text-2xl hover:text-gray-700 transition">&times;</button>
        </div>
        <div id="modalDebugInfo" class="debug-info hidden"></div>
        <div id="errorMessage" class="error-message hidden"></div>
        <div id="produitsList" class="space-y-4 mb-6 modal-content"></div>
        <div class="flex space-x-2">
          <button id="validerSansConfirmationBtn" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">‚úÖ Valider sans confirmation</button>
          <button id="validerAvecConfirmationBtn" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">üîÑ Valider avec confirmation</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de debug -->
  <div id="debugModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Informations de d√©bogage</h2>
        <button id="closeDebugModalBtn" class="text-gray-500 text-2xl hover:text-gray-700 transition">&times;</button>
      </div>
      <div id="debugContent" class="space-y-4"></div>
    </div>
  </div>

  <script>
    // Configuration - √Ä adapter avec votre URL de d√©ploiement r√©elle
    const CONFIG = {
      deployedURL: 'https://script.google.com/macros/s/AKfycbxWEfPlq6KBLE5hwk86e3O6xoaG3m1J8bIV9eu9IlS0AZOqYW2wpTBKJ84TBbH-DORPPw/exec',
      managers: [
        { email: 'thierry', password: '1234', role: 'manager' },
        { email: 'johan', password: '1234', role: 'manager' }
      ]
    };

    // √âtat de l'application
    let currentUser = null;
    let allUsers = [];
    let currentEmploye = null;
    let produits = [];

    // Fonctions utilitaires
    function showLoading(show) {
      document.getElementById('loadingSpinner').classList.toggle('hidden', !show);
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }

    function hideError(elementId) {
      const errorElement = document.getElementById(elementId);
      if (errorElement) errorElement.classList.add('hidden');
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat('fr-FR').format(date);
    }

    function showDebugInfo(info, elementId = 'debugInfo') {
      const debugElement = document.getElementById(elementId);
      if (debugElement) {
        debugElement.innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
        debugElement.classList.remove('hidden');
      }
    }

    // Charger les produits depuis le Google Sheet
    async function loadProduits(idEmploye) {
      showLoading(true);
      hideError('errorMessage');

      try {
        console.log(`[DEBUG] Chargement des produits pour l'employ√© ID: ${idEmploye}`);
        const response = await fetch(`${CONFIG.deployedURL}?action=getProduits&idEmploye=${idEmploye}`);

        if (!response.ok) {
          throw new Error(`Erreur r√©seau: ${response.status}`);
        }

        const data = await response.json();
        console.log('[DEBUG] R√©ponse compl√®te:', data);

        if (data.status === 'error') {
          console.error('[DEBUG] Erreur serveur:', data.message);
          showError('errorMessage', `Erreur: ${data.message}`);
          return [];
        }

        if (!data.products || !Array.isArray(data.products)) {
          console.error('[DEBUG] Format de r√©ponse inattendu:', data);
          showError('errorMessage', 'Format de r√©ponse inattendu');
          return [];
        }

        console.log(`[DEBUG] ${data.products.length} produits trouv√©s`);
        return data.products;

      } catch (error) {
        console.error('[DEBUG] Erreur:', error);
        showError('errorMessage', `Erreur: ${error.message}`);
        return [];
      } finally {
        showLoading(false);
      }
    }

    // Ouvrir la modale de contr√¥le
    async function openControleModal(employe) {
      currentEmploye = employe;
      document.getElementById('modalEmployeNom').textContent = `${employe.prenom} ${employe.nom}`;
      document.getElementById('controleModal').classList.remove('hidden');
      hideError('errorMessage');

      console.log(`[DEBUG] Ouverture modale pour employe ID: ${employe.ID_Employ√©}`);
      produits = await loadProduits(employe.ID_Employ√©);
      const produitsList = document.getElementById('produitsList');
      produitsList.innerHTML = '';

      if (!produits || produits.length === 0) {
        console.log('[DEBUG] Aucun produit trouv√©');
        produitsList.innerHTML = `
          <div class="p-4 text-center text-gray-500">
            <p>Aucun produit trouv√© pour cet employ√©</p>
            <p class="text-sm mt-2">ID: ${employe.ID_Employ√©}</p>
          </div>
        `;
        return;
      }

      produits.forEach((produit, index) => {
        const produitElement = document.createElement('div');
        produitElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded';
        const code = produit.Code_Produit || 'Code manquant';
        const designation = produit.D√©signation || 'D√©signation manquante';
        const qte = produit.Qt√©_Pr√©vue !== undefined ? produit.Qt√©_Pr√©vue : 'Qt√© non d√©finie';

        produitElement.innerHTML = `
          <span class="font-medium">
            ${code} - ${designation} (Pr√©vu: ${qte})
          </span>
          <div class="flex items-center space-x-2">
            <button class="qty-btn minus-btn" data-index="${index}">-</button>
            <span class="qte-display w-8 text-center">0</span>
            <button class="qty-btn plus-btn" data-index="${index}">+</button>
          </div>
        `;
        produitsList.appendChild(produitElement);
      });

      // Ajouter les √©couteurs d'√©v√©nements
      document.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', () => updateQte(btn.dataset.index, -1));
      });

      document.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', () => updateQte(btn.dataset.index, 1));
      });
    }

    // Mettre √† jour la quantit√©
    function updateQte(index, delta) {
      const qteElements = document.querySelectorAll('.qte-display');
      const currentQte = parseInt(qteElements[index].textContent);
      const newQte = Math.max(0, currentQte + delta);
      qteElements[index].textContent = newQte;
    }

    // Fermer la modale
    function closeControleModal() {
      document.getElementById('controleModal').classList.add('hidden');
    }

    // Valider le contr√¥le
    async function validerControle(avecConfirmation) {
      if (!currentEmploye) return;

      const produitsElements = document.querySelectorAll('.qte-display');
      let hasQte = false;

      for (let i = 0; i < produits.length; i++) {
        const qteControlee = parseInt(produitsElements[i].textContent);
        if (qteControlee > 0) {
          hasQte = true;
          try {
            const response = await fetch(CONFIG.deployedURL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                action: 'saveControle',
                ID_Employ√©: currentEmploye.ID_Employ√©,
                Code_Produit: produits[i].Code_Produit,
                Qt√©_Contr√¥l√©e: qteControlee,
              }),
            });

            if (!response.ok) {
              console.error('Erreur lors de l\'enregistrement');
            }
          } catch (error) {
            console.error('Erreur r√©seau:', error);
          }
        }
      }

      if (!hasQte) {
        alert('Veuillez saisir au moins une quantit√©');
        return;
      }

      alert(`Contr√¥le ${avecConfirmation ? 'en attente de validation' : 'valid√©'} avec succ√®s`);
      closeControleModal();
      loadEmployes();
    }

    // Charger la liste des employ√©s
    async function loadEmployes() {
      const listElement = document.getElementById('employesList');
      listElement.innerHTML = '';
      showLoading(true);

      try {
        const response = await fetch(`${CONFIG.deployedURL}?action=getEmployes`);
        if (!response.ok) throw new Error('Erreur r√©seau');

        const employesData = await response.json();
        if (!Array.isArray(employesData)) throw new Error('Donn√©es invalides');

        allUsers = [
          ...CONFIG.managers,
          ...employesData.map(emp => ({
            ID_Employ√©: emp.ID_Employ√© || '',
            email: (emp.Email || '').toLowerCase(),
            password: '1234',
            role: 'employe',
            nom: emp.Nom || '',
            prenom: emp.Pr√©nom || '',
            equipe: emp.Equipe || '',
            manager: String(emp.Equipe).includes('1') ? 'thierry' : 'johan'
          }))
        ];

        const employes = allUsers.filter(u =>
          u.role === 'employe' && u.manager === currentUser.email
        );

        if (employes.length === 0) {
          listElement.innerHTML = '<p class="text-gray-500 p-4">Aucun employ√© trouv√©</p>';
          return;
        }

        employes.forEach(emp => {
          const employeeItem = document.createElement('div');
          employeeItem.className = 'p-3 border rounded-lg bg-white flex justify-between items-center';
          employeeItem.innerHTML = `
            <div>
              <span class="status-badge status-new"></span>
              <span>${emp.prenom} ${emp.nom}</span>
            </div>
            <button class="controle-btn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition" data-email="${emp.email}">
              Contr√¥ler
            </button>
          `;
          listElement.appendChild(employeeItem);
        });

        // Ajouter les √©couteurs d'√©v√©nements
        document.querySelectorAll('.controle-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const employeEmail = btn.dataset.email;
            const employe = allUsers.find(u => u.email === employeEmail);
            openControleModal(employe);
          });
        });

      } catch (error) {
        console.error('Erreur lors du chargement des employ√©s:', error);
        listElement.innerHTML = '<p class="text-red-500 p-4">Erreur lors du chargement des employ√©s</p>';
      } finally {
        showLoading(false);
      }
    }

    // Fonction pour afficher les informations de debug
    async function showDebugModal() {
      showLoading(true);
      try {
        const response = await fetch(`${CONFIG.deployedURL}?action=debug`);
        if (!response.ok) {
          throw new Error(`Erreur r√©seau: ${response.status}`);
        }

        const data = await response.json();
        const debugContent = document.getElementById('debugContent');
        debugContent.innerHTML = '';

        if (data.status === 'error') {
          debugContent.innerHTML = `<div class="error-message p-4">${data.message || 'Erreur inconnue'}</div>`;
          document.getElementById('debugModal').classList.remove('hidden');
          return;
        }

        // V√©rifiez que `data.sheets` est un tableau
        if (!data.sheets || !Array.isArray(data.sheets)) {
          debugContent.innerHTML = `<div class="error-message p-4">Format de r√©ponse inattendu: ${JSON.stringify(data)}</div>`;
          document.getElementById('debugModal').classList.remove('hidden');
          return;
        }

        // Construisez le contenu de mani√®re s√©curis√©e
        let sheetsHTML = '';
        if (data.sheets.length > 0) {
          sheetsHTML = data.sheets.map(sheet => {
            const headers = Array.isArray(sheet.headers) ? sheet.headers.join(', ') : 'Aucun en-t√™te';
            const sampleData = sheet.sampleData ? JSON.stringify(sheet.sampleData, null, 2) : 'Aucune donn√©e';
            return `
              <div class="mb-4 p-4 border rounded-lg bg-gray-50">
                <h4 class="font-semibold mb-2 text-blue-600">${sheet.name || 'Nom manquant'}</h4>
                <div class="mb-2">
                  <strong>En-t√™tes:</strong> ${headers}
                </div>
                <div>
                  <strong>√âchantillon de donn√©es:</strong>
                  <pre class="bg-gray-100 p-2 rounded text-sm">${sampleData}</pre>
                </div>
              </div>
            `;
          }).join('');
        } else {
          sheetsHTML = '<p>Aucun onglet disponible</p>';
        }

        debugContent.innerHTML = `
          <div class="mb-6">
            <h3 class="font-bold text-lg mb-2">Configuration:</h3>
            <pre class="bg-gray-100 p-4 rounded">${data.config ? JSON.stringify(data.config, null, 2) : 'Aucune configuration'}</pre>
          </div>
          <div class="mb-6">
            <h3 class="font-bold text-lg mb-2">Onglets disponibles (${data.sheets.length})</h3>
            ${sheetsHTML}
          </div>
        `;
        document.getElementById('debugModal').classList.remove('hidden');

      } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des infos de debug:', error);
        document.getElementById('debugContent').innerHTML = `
          <div class="error-message p-4">
            Erreur lors de la r√©cup√©ration des informations: ${error.message}
          </div>
        `;
        document.getElementById('debugModal').classList.remove('hidden');
      } finally {
        showLoading(false);
      }
    }

    // Fermer la modale de debug
    function closeDebugModal() {
      document.getElementById('debugModal').classList.add('hidden');
    }

    // Gestion de la connexion
    async function login(event) {
      event.preventDefault();
      showLoading(true);
      hideError('loginError');

      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      try {
        console.log(`[DEBUG] Tentative de connexion avec: ${email}`);
        const response = await fetch(`${CONFIG.deployedURL}?action=getEmployes`);
        if (!response.ok) throw new Error(`Erreur r√©seau: ${response.status}`);

        const employesData = await response.json();
        if (!Array.isArray(employesData)) throw new Error('Donn√©es invalides');

        console.log('[DEBUG] Employ√©s re√ßus:', employesData);
        allUsers = [
          ...CONFIG.managers,
          ...employesData.map(emp => ({
            ID_Employ√©: emp.ID_Employ√© || '',
            email: (emp.Email || '').toLowerCase(),
            password: '1234',
            role: 'employe',
            nom: emp.Nom || '',
            prenom: emp.Pr√©nom || '',
            equipe: emp.Equipe || '',
            manager: String(emp.Equipe).includes('1') ? 'thierry' : 'johan'
          }))
        ];

        console.log('[DEBUG] Tous les utilisateurs:', allUsers);
        const user = allUsers.find(u => u.email === email && u.password === password);

        if (!user) {
          showError('loginError', 'Identifiant ou mot de passe incorrect');
          return;
        }

        currentUser = user;
        console.log('[DEBUG] Utilisateur connect√©:', currentUser);
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('managerApp').classList.remove('hidden');
        document.getElementById('currentDate').textContent = formatDate(new Date());
        loadEmployes();

      } catch (error) {
        console.error('[DEBUG] Erreur de connexion:', error);
        showError('loginError', 'Erreur de connexion. V√©rifiez votre connexion internet.');
      } finally {
        showLoading(false);
      }
    }

    // D√©connexion
    function logout() {
      document.getElementById('managerApp').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      currentUser = null;
      allUsers = [];
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginForm').addEventListener('submit', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('closeModalBtn').addEventListener('click', closeControleModal);
      document.getElementById('validerSansConfirmationBtn').addEventListener('click', () => validerControle(false));
      document.getElementById('validerAvecConfirmationBtn').addEventListener('click', () => validerControle(true));
      document.getElementById('debugBtn').addEventListener('click', showDebugModal);
      document.getElementById('closeDebugModalBtn').addEventListener('click', closeDebugModal);
    });
  </script>
</body>
</html>
