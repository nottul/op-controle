<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contr√¥les OP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; height: 100vh; }
    .hidden { display: none !important; }
    .status-badge {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-new { background-color: #6b7280; }
    .status-pending { background-color: #f59e0b; }
    .status-done { background-color: #10b981; }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- √âcran de chargement -->
  <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg flex flex-col items-center">
      <div class="spinner mb-4"></div>
      <p class="text-gray-700">Chargement en cours...</p>
    </div>
  </div>

  <!-- √âcran de connexion -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md w-80 text-center">
      <h1 class="text-2xl font-bold mb-6 text-blue-600">Contr√¥les OP</h1>
      <form id="loginForm" class="space-y-4">
        <input id="email" type="text" placeholder="Identifiant" class="w-full p-2 border rounded" required>
        <input id="password" type="password" placeholder="Mot de passe" class="w-full p-2 border rounded" required>
        <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded">Se connecter</button>
      </form>
      <p id="loginError" class="text-red-500 mt-2 hidden">Identifiant ou mot de passe incorrect</p>
    </div>
  </div>

  <!-- Interface Manager -->
  <div id="managerApp" class="hidden h-screen flex flex-col">
    <header class="bg-white p-4 shadow">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">üìã Contr√¥les - <span id="currentDate"></span></h1>
        <button id="logoutBtn" class="text-red-500">D√©connexion</button>
      </div>
    </header>

    <main class="flex-1 p-4 overflow-auto">
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-4">Mes Employ√©s</h2>
        <div id="employesList" class="space-y-2"></div>
      </div>
    </main>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      deployedURL: 'https://script.google.com/macros/s/AKfycbxWEfPlq6KBLE5hwk86e3O6xoaG3m1J8bIV9eu9IlS0AZOqYW2wpTBKJ84TBbH-DORPPw/exec',
      managers: [
        { email: 'thierry', password: '1234', role: 'manager' },
        { email: 'johan', password: '1234', role: 'manager' }
      ]
    };

    // √âtat de l'application
    let currentUser = null;
    let allUsers = [];

    // Fonctions utilitaires
    function showLoading(show) {
      document.getElementById('loadingSpinner').classList.toggle('hidden', !show);
    }

    function showError(message) {
      const errorElement = document.getElementById('loginError');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat('fr-FR').format(date);
    }

    // Gestion de la connexion
    async function login(event) {
      event.preventDefault();
      showLoading(true);
      showError('');

      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      try {
        // R√©cup√©rer les donn√©es des employ√©s
        const response = await fetch(CONFIG.deployedURL);
        if (!response.ok) throw new Error('Erreur r√©seau');

        const employesData = await response.json();
        if (!Array.isArray(employesData)) throw new Error('Donn√©es invalides');

        // Cr√©er la liste de tous les utilisateurs
        allUsers = [
          ...CONFIG.managers,
          ...employesData.map(emp => ({
            email: (emp.Email || '').toLowerCase(),
            password: '1234',
            role: 'employe',
            nom: emp.Nom || '',
            prenom: emp.Pr√©nom || '',
            equipe: emp.Equipe || '',
            manager: String(emp.Equipe).includes('1') ? 'thierry' : 'johan'
          }))
        ];

        // V√©rifier les identifiants
        const user = allUsers.find(u => u.email === email && u.password === password);
        if (!user) {
          showError('Identifiant ou mot de passe incorrect');
          return;
        }

        // Connexion r√©ussie
        currentUser = user;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('managerApp').classList.remove('hidden');
        document.getElementById('currentDate').textContent = formatDate(new Date());

        // Charger les employ√©s
        loadEmployes();

      } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur de connexion. V√©rifiez votre connexion internet.');
      } finally {
        showLoading(false);
      }
    }

    // Charger la liste des employ√©s
    function loadEmployes() {
      const listElement = document.getElementById('employesList');
      listElement.innerHTML = '';

      const employes = allUsers.filter(u =>
        u.role === 'employe' && u.manager === currentUser.email
      );

      if (employes.length === 0) {
        listElement.innerHTML = '<p class="text-gray-500">Aucun employ√© trouv√©</p>';
        return;
      }

      employes.forEach(emp => {
        const employeeItem = document.createElement('div');
        employeeItem.className = 'p-3 border rounded-lg bg-white flex justify-between items-center';

        const status = 'new'; // Statut par d√©faut
        employeeItem.innerHTML = `
          <div>
            <span class="status-badge status-${status}"></span>
            <span>${emp.prenom} ${emp.nom}</span>
          </div>
          <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm">
            Contr√¥ler
          </button>
        `;

        listElement.appendChild(employeeItem);
      });
    }

    // D√©connexion
    function logout() {
      document.getElementById('managerApp').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      currentUser = null;
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginForm').addEventListener('submit', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
    });
  </script>
</body>
</html>
