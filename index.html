<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contr√¥les OP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; height: 100vh; }
    .hidden { display: none !important; }
    .status-badge {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-new { background-color: #6b7280; }
    .status-pending { background-color: #f59e0b; }
    .status-done { background-color: #10b981; }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .qty-btn {
      width: 30px;
      height: 30px;
      font-size: 18px;
      font-weight: bold;
      background-color: #e5e7eb;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .modal-content {
      max-height: 80vh;
      overflow-y: auto;
    }
    .debug-info {
      background-color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-family: monospace;
      font-size: 0.875rem;
    }
    .error-message {
      color: #ef4444;
      background-color: #fee2e2;
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- √âcran de chargement -->
  <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg flex flex-col items-center">
      <div class="spinner mb-4"></div>
      <p class="text-gray-700">Chargement en cours...</p>
    </div>
  </div>

  <!-- √âcran de connexion -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md w-80 text-center">
      <h1 class="text-2xl font-bold mb-6 text-blue-600">Contr√¥les OP</h1>
      <form id="loginForm" class="space-y-4">
        <input id="email" type="text" placeholder="Identifiant" class="w-full p-2 border rounded" required>
        <input id="password" type="password" placeholder="Mot de passe" class="w-full p-2 border rounded" required>
        <button type="submit" class="w-full bg-blue-600 text-white p-2 rounded">Se connecter</button>
      </form>
      <p id="loginError" class="text-red-500 mt-2 hidden">Identifiant ou mot de passe incorrect</p>
    </div>
  </div>

  <!-- Interface Manager -->
  <div id="managerApp" class="hidden h-screen flex flex-col">
    <header class="bg-white p-4 shadow">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">üìã Contr√¥les - <span id="currentDate"></span></h1>
        <div>
          <button id="debugBtn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded text-sm mr-2">Debug</button>
          <button id="logoutBtn" class="text-red-500">D√©connexion</button>
        </div>
      </div>
    </header>
    <main class="flex-1 p-4 overflow-auto">
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-4">Mes Employ√©s</h2>
        <div id="debugInfo" class="debug-info hidden"></div>
        <div id="employesList" class="space-y-2"></div>
      </div>
    </main>
  </div>

  <!-- Modal de contr√¥le -->
  <div id="controleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Contr√¥le pour <span id="modalEmployeNom"></span></h2>
          <button id="closeModalBtn" class="text-gray-500 text-2xl">&times;</button>
        </div>
        <div id="modalDebugInfo" class="debug-info hidden"></div>
        <div id="errorMessage" class="error-message hidden"></div>
        <div id="produitsList" class="space-y-4 mb-6 modal-content"></div>
        <div class="flex space-x-2">
          <button id="validerSansConfirmationBtn" class="flex-1 bg-green-600 text-white py-2 rounded">‚úÖ Valider sans confirmation</button>
          <button id="validerAvecConfirmationBtn" class="flex-1 bg-blue-600 text-white py-2 rounded">üîÑ Valider avec confirmation</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de debug -->
  <div id="debugModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Informations de d√©bogage</h2>
        <button id="closeDebugModalBtn" class="text-gray-500 text-2xl">&times;</button>
      </div>
      <div id="debugContent" class="space-y-4"></div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      deployedURL: 'https://script.google.com/macros/s/AKfycbxWEfPlq6KBLE5hwk86e3O6xoaG3m1J8bIV9eu9IlS0AZOqYW2wpTBKJ84TBbH-DORPPw/exec',
      managers: [
        { email: 'thierry', password: '1234', role: 'manager' },
        { email: 'johan', password: '1234', role: 'manager' }
      ]
    };

    // √âtat de l'application
    let currentUser = null;
    let allUsers = [];
    let currentEmploye = null;
    let produits = [];
    let debugInfo = {};

    // Fonctions utilitaires
    function showLoading(show) {
      document.getElementById('loadingSpinner').classList.toggle('hidden', !show);
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }

    function hideError(elementId) {
      document.getElementById(elementId).classList.add('hidden');
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat('fr-FR').format(date);
    }

    function showDebugInfo(info, elementId = 'debugInfo') {
      const debugElement = document.getElementById(elementId);
      debugElement.innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
      debugElement.classList.remove('hidden');
    }

    // Charger les produits depuis le Google Sheet avec d√©bogage
    async function loadProduits(idEmploye) {
      showLoading(true);
      hideError('errorMessage');

      try {
        console.log(`[DEBUG] Chargement des produits pour l'employ√© ID: ${idEmploye}`);

        // 1. Appel normal pour obtenir les produits
        const response = await fetch(`${CONFIG.deployedURL}?action=getProduits&idEmploye=${idEmploye}`);
        const data = await response.json();
        console.log('[DEBUG] R√©ponse compl√®te:', data);

        // 2. V√©rification de la r√©ponse
        if (data.status === 'error') {
          console.error('[DEBUG] Erreur serveur:', data.message);
          showError('errorMessage', `Erreur: ${data.message}`);

          if (data.availableSheets) {
            console.log('[DEBUG] Onglets disponibles:', data.availableSheets);
            showDebugInfo({
              error: data.message,
              availableSheets: data.availableSheets,
              lookedFor: data.lookedFor
            }, 'modalDebugInfo');
          }

          if (data.headers) {
            console.log('[DEBUG] En-t√™tes disponibles:', data.headers);
          }

          return [];
        }

        if (!data.products || !Array.isArray(data.products)) {
          console.error('[DEBUG] Format de r√©ponse inattendu. Attendu: Array, Re√ßu:', typeof data.products, data.products);
          showError('errorMessage', 'Format de r√©ponse inattendu du serveur');
          return [];
        }

        console.log(`[DEBUG] ${data.products.length} produits trouv√©s`);
        return data.products;

      } catch (error) {
        console.error('[DEBUG] Erreur r√©seau:', error);
        showError('errorMessage', `Erreur r√©seau: ${error.message}`);
        return [];
      } finally {
        showLoading(false);
      }
    }

    // Ouvrir la modale de contr√¥le avec d√©bogage am√©lior√©
    async function openControleModal(employe) {
      currentEmploye = employe;
      document.getElementById('modalEmployeNom').textContent = `${employe.prenom} ${employe.nom}`;
      document.getElementById('controleModal').classList.remove('hidden');
      hideError('errorMessage');
      document.getElementById('modalDebugInfo').classList.add('hidden');

      console.log(`[DEBUG] Ouverture modale pour employe ID: ${employe.ID_Employ√©}`);

      produits = await loadProduits(employe.ID_Employ√©);
      const produitsList = document.getElementById('produitsList');
      produitsList.innerHTML = '';

      if (!produits || produits.length === 0) {
        console.log('[DEBUG] Aucun produit trouv√© pour cet employ√©');
        produitsList.innerHTML = `
          <div class="p-4 text-center text-gray-500">
            <p>Aucun produit trouv√© pour cet employ√©</p>
            <p class="text-sm mt-2">ID Employ√©: ${employe.ID_Employ√©}</p>
            <p class="text-sm">Nom: ${employe.prenom} ${employe.nom}</p>
          </div>
        `;
        return;
      }

      console.log('[DEBUG] Produits √† afficher:', produits);

      produits.forEach((produit, index) => {
        const produitElement = document.createElement('div');
        produitElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded';

        // V√©rification compl√®te des propri√©t√©s avec valeurs par d√©faut
        const code = produit.Code_Produit || 'Code manquant';
        const designation = produit.D√©signation || 'D√©signation manquante';
        const qte = produit.Qt√©_Pr√©vue !== undefined ? produit.Qt√©_Pr√©vue : 'Qt√© non d√©finie';

        produitElement.innerHTML = `
          <span class="font-medium">
            ${code} - ${designation} (Pr√©vu: ${qte})
          </span>
          <div class="flex items-center space-x-2">
            <button class="qty-btn minus-btn" data-index="${index}">-</button>
            <span class="qte-display w-8 text-center">0</span>
            <button class="qty-btn plus-btn" data-index="${index}">+</button>
          </div>
        `;
        produitsList.appendChild(produitElement);
      });

      // Ajouter les √©couteurs d'√©v√©nements pour les boutons +/- apr√®s avoir charg√© les produits
      document.querySelectorAll('.minus-btn').forEach(btn => {
        btn.addEventListener('click', () => updateQte(btn.dataset.index, -1));
      });
      document.querySelectorAll('.plus-btn').forEach(btn => {
        btn.addEventListener('click', () => updateQte(btn.dataset.index, 1));
      });
    }

    // Mettre √† jour la quantit√©
    function updateQte(index, delta) {
      const qteElements = document.querySelectorAll('.qte-display');
      const currentQte = parseInt(qteElements[index].textContent);
      const newQte = Math.max(0, currentQte + delta);
      qteElements[index].textContent = newQte;
    }

    // Fermer la modale
    function closeControleModal() {
      document.getElementById('controleModal').classList.add('hidden');
    }

    // Valider le contr√¥le
    async function validerControle(avecConfirmation) {
      if (!currentEmploye) return;

      const produitsElements = document.querySelectorAll('.qte-display');
      let hasQte = false;
      let allUpdatesSuccessful = true;

      for (let i = 0; i < produits.length; i++) {
        const qteControlee = parseInt(produitsElements[i].textContent);
        if (qteControlee > 0) {
          hasQte = true;
          try {
            const response = await fetch(CONFIG.deployedURL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                ID_Employ√©: currentEmploye.ID_Employ√©,
                Code_Produit: produits[i].Code_Produit,
                Qt√©_Contr√¥l√©e: qteControlee,
              }),
            });

            const result = await response.json();
            if (result.status !== 'success') {
              console.error('[DEBUG] Erreur lors de l'enregistrement du produit:', produits[i], result.message);
              allUpdatesSuccessful = false;
            } else {
              console.log('[DEBUG] Enregistrement r√©ussi pour:', produits[i].Code_Produit);
            }
          } catch (error) {
            console.error('[DEBUG] Erreur r√©seau lors de l'enregistrement:', error);
            allUpdatesSuccessful = false;
          }
        }
      }

      if (!hasQte) {
        alert('Veuillez saisir au moins une quantit√©');
        return;
      }

      const successMessage = allUpdatesSuccessful ?
        `Contr√¥le ${avecConfirmation ? 'en attente de validation' : 'valid√©'} avec succ√®s` :
        `Contr√¥le ${avecConfirmation ? 'en attente de validation' : 'valid√©'}, mais certaines mises √† jour ont √©chou√©. V√©rifiez les logs pour plus de d√©tails.`;

      alert(successMessage);
      closeControleModal();
      loadEmployes();
    }

    // Charger la liste des employ√©s
    async function loadEmployes() {
      const listElement = document.getElementById('employesList');
      listElement.innerHTML = '';
      showLoading(true);

      try {
        const response = await fetch(`${CONFIG.deployedURL}?action=getEmployes`);
        if (!response.ok) throw new Error('Erreur r√©seau');

        const employesData = await response.json();
        if (!Array.isArray(employesData)) throw new Error('Donn√©es invalides');

        allUsers = [
          ...CONFIG.managers,
          ...employesData.map(emp => ({
            ID_Employ√©: emp.ID_Employ√© || '',
            email: (emp.Email || '').toLowerCase(),
            password: '1234',
            role: 'employe',
            nom: emp.Nom || '',
            prenom: emp.Pr√©nom || '',
            equipe: emp.Equipe || '',
            manager: String(emp.Equipe).includes('1') ? 'thierry' : 'johan'
          }))
        ];

        const employes = allUsers.filter(u =>
          u.role === 'employe' && u.manager === currentUser.email
        );

        if (employes.length === 0) {
          listElement.innerHTML = '<p class="text-gray-500">Aucun employ√© trouv√©</p>';
          return;
        }

        employes.forEach(emp => {
          const employeeItem = document.createElement('div');
          employeeItem.className = 'p-3 border rounded-lg bg-white flex justify-between items-center';
          const statut = 'new'; // Simplifi√© pour l'exemple
          employeeItem.innerHTML = `
            <div>
              <span class="status-badge status-${statut}"></span>
              <span>${emp.prenom} ${emp.nom}</span>
            </div>
            <button class="controle-btn bg-blue-500 text-white px-3 py-1 rounded text-sm" data-email="${emp.email}">
              Contr√¥ler
            </button>
          `;
          listElement.appendChild(employeeItem);
        });

        // Ajouter les √©couteurs d'√©v√©nements aux boutons Contr√¥ler
        document.querySelectorAll('.controle-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const employeEmail = btn.dataset.email;
            const employe = allUsers.find(u => u.email === employeEmail);
            openControleModal(employe);
          });
        });

      } catch (error) {
        console.error('[DEBUG] Erreur lors du chargement des employ√©s:', error);
        listElement.innerHTML = '<p class="text-red-500">Erreur lors du chargement des employ√©s. Voir console pour d√©tails.</p>';
      } finally {
        showLoading(false);
      }
    }

    // Fonction pour afficher les informations de debug
    async function showDebugModal() {
      showLoading(true);
      try {
        const response = await fetch(`${CONFIG.deployedURL}?action=debug`);
        const data = await response.json();
        console.log('[DEBUG] Informations compl√®tes:', data);

        const debugContent = document.getElementById('debugContent');
        debugContent.innerHTML = '';

        if (data.status === 'error') {
          debugContent.innerHTML = `<div class="error-message">${data.message}</div>`;
        } else {
          debugContent.innerHTML = `
            <div class="mb-4">
              <h3 class="font-bold mb-2">Configuration:</h3>
              <pre>${JSON.stringify(data.config, null, 2)}</pre>
            </div>

            <div class="mb-4">
              <h3 class="font-bold mb-2">Onglets disponibles (${data.sheets.length}):</h3>
              ${data.sheets.map(sheet => `
                <div class="mb-4 p-4 border rounded-lg">
                  <h4 class="font-semibold mb-2">${sheet.name}</h4>
                  <div class="mb-2">
                    <strong>En-t√™tes:</strong> ${sheet.headers.join(', ')}
                  </div>
                  <div>
                    <strong>√âchantillon de donn√©es (2 lignes):</strong>
                    <pre>${JSON.stringify(sheet.sampleData, null, 2)}</pre>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        document.getElementById('debugModal').classList.remove('hidden');
      } catch (error) {
        console.error('[DEBUG] Erreur lors de la r√©cup√©ration des infos de debug:', error);
        document.getElementById('debugContent').innerHTML = `
          <div class="error-message">
            Erreur lors de la r√©cup√©ration des informations de debug: ${error.message}
          </div>
        `;
      } finally {
        showLoading(false);
      }
    }

    // Fermer la modale de debug
    function closeDebugModal() {
      document.getElementById('debugModal').classList.add('hidden');
    }

    // Gestion de la connexion
    async function login(event) {
      event.preventDefault();
      showLoading(true);
      hideError('loginError');
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(`${CONFIG.deployedURL}?action=getEmployes`);
        if (!response.ok) throw new Error('Erreur r√©seau');

        const employesData = await response.json();
        if (!Array.isArray(employesData)) throw new Error('Donn√©es invalides');

        allUsers = [
          ...CONFIG.managers,
          ...employesData.map(emp => ({
            ID_Employ√©: emp.ID_Employ√© || '',
            email: (emp.Email || '').toLowerCase(),
            password: '1234',
            role: 'employe',
            nom: emp.Nom || '',
            prenom: emp.Pr√©nom || '',
            equipe: emp.Equipe || '',
            manager: String(emp.Equipe).includes('1') ? 'thierry' : 'johan'
          }))
        ];

        const user = allUsers.find(u => u.email === email && u.password === password);
        if (!user) {
          showError('loginError', 'Identifiant ou mot de passe incorrect');
          return;
        }

        currentUser = user;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('managerApp').classList.remove('hidden');
        document.getElementById('currentDate').textContent = formatDate(new Date());
        loadEmployes();

      } catch (error) {
        console.error('[DEBUG] Erreur de connexion:', error);
        showError('loginError', 'Erreur de connexion. V√©rifiez votre connexion internet.');
      } finally {
        showLoading(false);
      }
    }

    // D√©connexion
    function logout() {
      document.getElementById('managerApp').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      currentUser = null;
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginForm').addEventListener('submit', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('closeModalBtn').addEventListener('click', closeControleModal);
      document.getElementById('validerSansConfirmationBtn').addEventListener('click', () => validerControle(false));
      document.getElementById('validerAvecConfirmationBtn').addEventListener('click', () => validerControle(true));
      document.getElementById('debugBtn').addEventListener('click', showDebugModal);
      document.getElementById('closeDebugModalBtn').addEventListener('click', closeDebugModal);
    });
  </script>
</body>
</html>
