<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contr√¥les - Ouest Palettes</title>
  <!-- Utilisation de Tailwind CSS via CDN (comme dans votre exemple initial) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .status-badge { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
    .status-done { background-color: #10b981; }       /* vert ‚úÖ */
    .status-pending { background-color: #f59e0b; }   /* jaune üü° */
    .status-new { background-color: #6b7280; }       /* gris ‚ö™ */
    .qty-btn { width: 30px; height: 30px; font-size: 18px; font-weight: bold; }
    /* Cache les sections par d√©faut */
    #managerApp, #employeApp, #modalControle, #loadingSpinner { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- √âcran de connexion -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen px-6">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
      <img src="https://i.ibb.co/6cRdDfrM/logo-ouest-palettes.png" alt="Ouest Palettes" class="w-40 h-12 mx-auto mb-4" />
      <p class="text-lg font-semibold text-blue-600 mb-6">Contr√¥les de Production</p>
      
      <!-- Formulaire de connexion - Utilise un gestionnaire d'√©v√©nements JS au lieu de onsubmit -->
      <form id="loginForm" class="space-y-4">
        <!-- autocomplete="username" aide les gestionnaires de mots de passe -->
        <input id="email" type="text" placeholder="Identifiant" class="w-full p-3 border border-gray-300 rounded-lg" required autocomplete="username" />
        <!-- autocomplete="current-password" aide les gestionnaires de mots de passe -->
        <input id="password" type="password" placeholder="Mot de passe" class="w-full p-3 border border-gray-300 rounded-lg" required autocomplete="current-password" />
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold">Se connecter</button>
      </form>

      <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Identifiant ou mot de passe incorrect</p>
    </div>
  </div>

  <!-- Indicateur de chargement -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
     <div class="bg-white p-6 rounded-full shadow-lg">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-2 text-center">Chargement...</p>
     </div>
  </div>

  <!-- Application Manager -->
  <div id="managerApp">
    <header class="bg-white shadow-sm p-4">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">üìã Contr√¥les ‚Äî <span id="currentDate"></span></h1>
        <button id="logoutBtn" class="text-sm text-red-500">D√©connexion</button>
      </div>
    </header>

    <div class="flex-1 p-4 space-y-6 overflow-y-auto">
      <div class="bg-white p-5 rounded-xl shadow">
        <h2 class="font-semibold mb-4">Mes Employ√©s</h2>
        <div id="employesList" class="space-y-3">
            <!-- Liste des employ√©s sera ins√©r√©e ici par JS -->
        </div>
      </div>
    </div>

    <div id="offlineBar" class="hidden bg-yellow-500 text-white text-center py-2 text-sm">
        üì¥ Hors ligne. Les donn√©es seront envoy√©es d√®s que vous serez en ligne.
    </div>
  </div>

  <!-- Application Employ√© -->
  <div id="employeApp">
    <header class="bg-white shadow-sm p-4">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">üîî Notifications</h1>
        <button id="logoutBtnEmploye" class="text-sm text-red-500">D√©connexion</button>
      </div>
    </header>

    <div class="flex-1 p-4 space-y-6 overflow-y-auto">
      <div class="bg-white p-5 rounded-xl shadow">
        <h2 class="font-semibold mb-4">Contr√¥les en attente</h2>
        <div id="notificationsList" class="space-y-3">
             <!-- Notifications seront ins√©r√©es ici par JS -->
        </div>
        <p id="noNotifications" class="text-gray-500 text-center py-4 hidden">
            Aucun contr√¥le en attente
        </p>
      </div>
    </div>
  </div>

  <!-- Modal Fiche Contr√¥le -->
  <div id="modalControle" style="display: none;">
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 relative">
        <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
        <h2 class="text-xl font-bold mb-4">üìÖ <span id="modalDate"></span></h2>
        <h3 class="text-lg font-semibold mb-4">üë§ <span id="modalEmployeNom"></span></h3>

        <div id="produitsList" class="space-y-4 mb-6">
            <!-- Liste des produits avec +/- sera ins√©r√©e ici par JS -->
        </div>

        <div class="flex space-x-2">
          <button class="validerBtn flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold"
                  data-attente="false">
              ‚úÖ Valider sans confirmation
          </button>
          <button class="validerBtn flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold"
                  data-attente="true">
              üîÑ Valider et attendre confirmation
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 left-1/2 bg-black text-white px-4 py-2 rounded-lg text-sm hidden transform -translate-x-1/2 transition-opacity duration-300"></div>

  <script>
    // IIFE (Immediately Invoked Function Expression) pour √©viter les conflits de scope global
    (() => { 
      // ---------- CONFIG ----------
      const CONFIG = {
        // Liste des managers cod√©s en dur (ou pourrait √™tre charg√©e dynamiquement aussi)
        managers: [
          { email: 'thierry', password: '1234', role: 'manager', equipe: 'Atelier Brest' },
          { email: 'johan', password: '1234', role: 'manager', equipe: 'Atelier Rennes' }
        ],
        // *** IMPORTANT : Mettez ICI l'URL de VOTRE script Google Apps Script que vous avez copi√©e ***
        // Exemple: urlScript: 'https://script.google.com/macros/s/AKfycbzXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec',
        urlScript: 'https://script.google.com/macros/s/AKfycbzdJ93EYEMEWM1QJQtSdLk82pFDzfsKpwcIK3YrEa97oB0Xt3rUCebmd12UCXOuP1mU/exec',
        delaiAutoValidation: 2 * 60 * 60 * 1000 // 2 heures en ms
      };

      // ---------- √âTAT de l'Application ----------
      let currentUser = null;
      let allUsers = []; // Sera rempli avec les managers + employ√©s du Sheet
      let controlesEnCours = JSON.parse(localStorage.getItem('controlesEnCours_palettes') || '{}');
      let notifications = JSON.parse(localStorage.getItem('notifications_palettes') || '[]');
      let timers = JSON.parse(localStorage.getItem('timers_palettes') || '{}');

      // ---------- UTILITAIRES ----------
      function formatDate(date) {
        return new Intl.DateTimeFormat('fr-FR').format(date);
      }

      function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
      }

      function showLoading(show) {
          const spinner = document.getElementById('loadingSpinner');
          if (show) {
              spinner.style.display = 'flex';
          } else {
              spinner.style.display = 'none';
          }
      }

      function checkOnlineStatus() {
        const bar = document.getElementById('offlineBar');
        const updateBar = () => {
            if (navigator.onLine) {
                bar?.classList.add('hidden');
                // syncOfflineData(); // Optionnel: tenter de synchroniser si on revient en ligne
            } else {
                bar?.classList.remove('hidden');
            }
        };
        window.addEventListener('online', updateBar);
        window.addEventListener('offline', updateBar);
        updateBar(); // V√©rifier l'√©tat initial
      }

       // ---------- COMMUNICATION AVEC GOOGLE APPS SCRIPT ----------
       async function sendToGoogleScript(data) {
            if (!navigator.onLine) {
                showToast('‚ö†Ô∏è Mode hors ligne ‚Äî sauvegard√© localement');
                // Sauvegarder localement pour envoi diff√©r√©
                const offlineQueue = JSON.parse(localStorage.getItem('offlineQueue_palettes') || '[]');
                offlineQueue.push({...data, timestamp: Date.now()});
                localStorage.setItem('offlineQueue_palettes', JSON.stringify(offlineQueue));
                return {status: 'offline', message: 'Sauvegard√© localement'};
            }

            try {
                console.log("Envoi des donn√©es au script GAS:", data);
                const response = await fetch(CONFIG.urlScript, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' } // <-- Important: application/json
                });

                if (!response.ok) {
                   const errorText = await response.text();
                   console.error("Erreur HTTP:", response.status, errorText);
                   throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log("R√©ponse du script GAS:", result);

                if (result.status !== 'success') {
                    throw new Error(result.message || "Erreur inconnue du script Google Apps");
                }

                console.log("Donn√©es envoy√©es avec succ√®s:", result);
                return result;

            } catch (error) {
                console.error('Erreur lors de l\'envoi au script GAS:', error);
                showToast('‚ö†Ô∏è Erreur d‚Äôenvoi ‚Äî sauvegard√© localement');
                // En cas d'erreur r√©seau, sauvegarder aussi localement
                const offlineQueue = JSON.parse(localStorage.getItem('offlineQueue_palettes') || '[]');
                offlineQueue.push({...data, timestamp: Date.now(), error: error.message});
                localStorage.setItem('offlineQueue_palettes', JSON.stringify(offlineQueue));
                return {status: 'error', message: error.message};
            }
        }

        // ---------- CHARGEMENT DES DONN√âES ----------
        async function loadEmployesFromSheet() {
            showLoading(true);
            try {
                console.log("Chargement des employ√©s depuis le Sheet via:", CONFIG.urlScript);
                const response = await fetch(CONFIG.urlScript); // Appel GET
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Erreur HTTP lors du chargement des employ√©s:", response.status, errorText);
                    throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                }
                const employesData = await response.json();
                console.log("Employ√©s charg√©s:", employesData);
                
                // V√©rifier si la r√©ponse contient une erreur du script
                if (employesData && employesData.status === 'error') {
                     throw new Error(employesData.message || "Erreur renvoy√©e par le script Google Apps");
                }
                
                // Transformer les employ√©s en objets utilisateurs
                // S'assurer que les cl√©s correspondent aux noms de colonnes de votre Sheet
                const employes = Array.isArray(employesData) ? employesData.map(emp => ({
                    email: emp.Email || emp.email || emp.EMAIL || '',
                    password: '1234', // Mot de passe par d√©faut, ou g√©r√© autrement
                    role: 'employe',
                    equipe: emp.Equipe || emp.equipe || emp['Equipe'] || '', // G√©rer les diff√©rences de casse/nom
                    manager: (emp.Equipe || emp.equipe || emp['Equipe']) === 'Atelier Brest' ? 'thierry' : 'johan'
                })) : [];
                
                // Fusionner avec les managers
                allUsers = [...CONFIG.managers, ...employes];
                console.log("Liste compl√®te des utilisateurs:", allUsers);
                
                // Mettre √† jour l'affichage
                loadEmployes();
                
            } catch (error) {
                console.error("Erreur lors du chargement des employ√©s:", error);
                showToast("‚ùå Erreur de chargement des employ√©s: " + error.message);
                // En cas d'erreur, on peut charger une liste locale ou afficher un message
                // Ici, on reste sur les managers seulement comme fallback
                allUsers = [...CONFIG.managers]; 
                loadEmployes();
            } finally {
                showLoading(false);
            }
        }


      // ---------- AUTHENTIFICATION ----------
      async function login(email, password) {
        // Trouver l'utilisateur dans la liste (allUsers sera remplie apr√®s chargement)
        const user = allUsers.find(u => u.email === email && u.password === password);
        if (user) {
          currentUser = user;
          document.getElementById('loginScreen').style.display = 'none';
          if (user.role === 'manager') {
            document.getElementById('managerApp').style.display = 'flex';
            // Charger les employ√©s depuis le Sheet ici, apr√®s une connexion manager r√©ussie
            await loadEmployesFromSheet();
          } else {
            document.getElementById('employeApp').style.display = 'flex';
            loadNotifications();
          }
          document.getElementById('currentDate').textContent = formatDate(new Date());
          document.getElementById('modalDate').textContent = formatDate(new Date());
          checkOnlineStatus();
          // syncOfflineData(); // Optionnel: tenter de sync au login
          return true;
        } else {
          return false;
        }
      }

      function logout() {
        currentUser = null;
        allUsers = [];
        // Cacher toutes les sections principales
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('managerApp').style.display = 'none';
        document.getElementById('employeApp').style.display = 'none';
        document.getElementById('modalControle').style.display = 'none';
        // R√©initialiser les formulaires
        document.getElementById('loginForm').reset();
        document.getElementById('loginError').classList.add('hidden');
         // Vider la liste des employ√©s
        document.getElementById('employesList').innerHTML = '';
      }

      // ---------- GESTION DES EMPLOY√âS (Manager) ----------
       function loadEmployes() {
            const list = document.getElementById('employesList');
            list.innerHTML = ''; // Vider la liste

            // Filtrer les employ√©s appartenant √† l'√©quipe du manager courant
            const employesDuManager = allUsers.filter(u =>
                u.role === 'employe' && u.manager === currentUser.email
            );

            if (employesDuManager.length === 0) {
                list.innerHTML = '<p class="text-gray-500">Aucun employ√© trouv√©.</p>';
                return;
            }

            employesDuManager.forEach(emp => {
                // D√©terminer le statut du contr√¥le pour cet employ√©
                let statut = 'new'; // ‚ö™ Par d√©faut
                let label = 'Non contr√¥l√©';
                if (controlesEnCours[emp.email]?.statut === 'pending') {
                    statut = 'pending'; // üü°
                    label = 'En attente de validation';
                } else if (controlesEnCours[emp.email]?.statut === 'done') {
                    statut = 'done'; // ‚úÖ
                    label = 'Contr√¥le valid√©';
                }

                const item = document.createElement('div');
                item.className = 'border p-3 rounded-lg bg-gray-50 flex justify-between items-center';
                // Extraire le pr√©nom/nom de l'email ou d'autres champs si disponibles
                const displayName = emp.email.split('@')[0].split('.').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                item.innerHTML = `
                    <div>
                        <span class="status-badge status-${statut}"></span>
                        <span class="font-medium">${displayName}</span>
                    </div>
                    <button class="openControleBtn bg-blue-600 text-white px-3 py-1 rounded text-sm"
                            data-employe-email="${emp.email}">
                        ${statut === 'new' ? 'Contr√¥ler' : 'Modifier'}
                    </button>
                `;
                list.appendChild(item);
            });

            // Ajouter les √©couteurs d'√©v√©nements aux boutons
            document.querySelectorAll('.openControleBtn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const employeEmail = event.target.dataset.employeEmail;
                    openControle(employeEmail);
                });
            });
        }


        // --- FONCTIONS DE CONTROLE ---

        // Fonction pour ouvrir le modal de contr√¥le
        function openControle(employeEmail) {
            console.log("Ouverture du contr√¥le pour:", employeEmail);
            const employe = allUsers.find(u => u.email === employeEmail);
            if (!employe) {
                console.error("Employ√© non trouv√©:", employeEmail);
                showToast("Erreur: Employ√© non trouv√©.");
                return;
            }

            document.getElementById('modalEmployeNom').textContent = employe.email;

            // Charger les produits depuis localStorage ou initialiser
            const produits = controlesEnCours[employe.email]?.produits || [
                { designation: 'Palette EURO neuve', qt√©: 0 },
                { designation: 'Palette r√©par√©e H1', qt√©: 0 },
                { designation: 'Palette perdue', qt√©: 0 }
            ];

            const produitsList = document.getElementById('produitsList');
            produitsList.innerHTML = '';

            produits.forEach((prod, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg';
                div.innerHTML = `
                    <span>${prod.designation}</span>
                    <div class="flex items-center space-x-2">
                        <button class="qty-btn bg-gray-300 rounded decreaseQtyBtn" data-employe="${employeEmail}" data-index="${index}">-</button>
                        <span id="qty-${employeEmail}-${index}" class="font-bold w-12 text-center">${prod.qt√©}</span>
                        <button class="qty-btn bg-gray-300 rounded increaseQtyBtn" data-employe="${employeEmail}" data-index="${index}">+</button>
                    </div>
                `;
                produitsList.appendChild(div);
            });

            // Sauvegarder dans l'√©tat temporaire
            if (!controlesEnCours[employeEmail]) {
                 controlesEnCours[employeEmail] = {};
            }
            controlesEnCours[employeEmail].produits = produits;
            localStorage.setItem('controlesEnCours_palettes', JSON.stringify(controlesEnCours));

            // Afficher le modal
            document.getElementById('modalControle').style.display = 'block';

            // Ajouter les √©couteurs d'√©v√©nements aux boutons +/- du modal
            document.querySelectorAll('.decreaseQtyBtn').forEach(btn => {
                btn.addEventListener('click', handleQtyBtnClick);
            });
            document.querySelectorAll('.increaseQtyBtn').forEach(btn => {
                btn.addEventListener('click', handleQtyBtnClick);
            });

            // Ajouter les √©couteurs d'√©v√©nements aux boutons de validation du modal
            document.querySelectorAll('.validerBtn').forEach(btn => {
                btn.addEventListener('click', handleValiderBtnClick);
            });
        }

        // Fonction pour fermer le modal
        function closeModal() {
            document.getElementById('modalControle').style.display = 'none';
        }

        // Gestionnaire d'√©v√©nements pour les boutons +/-
        function handleQtyBtnClick(event) {
             const empEmail = event.target.dataset.employe;
             const idx = parseInt(event.target.dataset.index);
             const isIncrease = event.target.classList.contains('increaseQtyBtn');
             updateQty(empEmail, idx, isIncrease ? 1 : -1);
        }

        // Gestionnaire d'√©v√©nements pour les boutons de validation
        async function handleValiderBtnClick(event) {
             const attenteConfirmation = event.target.dataset.attente === 'true';
             console.log("Bouton 'Valider' cliqu√©. Attente confirmation:", attenteConfirmation);
             await validerControle(attenteConfirmation);
        }

        // Fonction principale de validation
        async function validerControle(attenteConfirmation) {
            console.log("Fonction validerControle appel√©e avec attenteConfirmation:", attenteConfirmation);
            // V√©rifier d'abord si le modal est ouvert et qu'un employ√© est s√©lectionn√©
            const employeNomElement = document.getElementById('modalEmployeNom');
            if (!employeNomElement || !employeNomElement.textContent) {
                showToast("Erreur: Aucun employ√© s√©lectionn√© pour le contr√¥le.");
                return;
            }
            const employeNom = employeNomElement.textContent;
            const employe = allUsers.find(u => u.email === employeNom);
            if (!employe) {
                showToast("Erreur: Employ√© non trouv√©.");
                return;
            }

            const produits = controlesEnCours[employe.email]?.produits;
            if (!produits || produits.length === 0) {
                alert('Aucun produit √† contr√¥ler.');
                return;
            }

            // V√©rifier qu'au moins une quantit√© est saisie
            const totalQty = produits.reduce((sum, p) => sum + p.qt√©, 0);
            if (totalQty === 0) {
                alert('Veuillez saisir au moins une quantit√©.');
                return;
            }

            const controle = {
                manager: currentUser.email,
                employe: employe.email,
                produits: produits,
                date: new Date().toISOString(),
                statut: attenteConfirmation ? 'pending' : 'done',
                reponseEmploye: null,
                timestampValidation: Date.now()
            };

            console.log("Donn√©es du contr√¥le √† envoyer:", controle);

            // Mettre √† jour l'√©tat local
            controlesEnCours[employe.email] = controle;
            localStorage.setItem('controlesEnCours_palettes', JSON.stringify(controlesEnCours));

            if (attenteConfirmation) {
                // Ajouter notification pour l'employ√©
                const notif = {
                    id: Date.now().toString(),
                    ...controle
                };
                notifications.push(notif);
                localStorage.setItem('notifications_palettes', JSON.stringify(notifications));
            }

            // Envoyer les donn√©es au script Google Apps Script
            showToast("Envoi des donn√©es en cours...");
            try {
                 const result = await sendToGoogleScript(controle);
                 console.log("R√©sultat de l'envoi:", result);

                 if (result.status === 'success') {
                     closeModal();
                     loadEmployes(); // Recharger la liste pour mettre √† jour le statut
                     showToast(`‚úÖ Contr√¥le enregistr√© pour ${employeNom}`);
                 } else if (result.status === 'offline') {
                      closeModal();
                      loadEmployes();
                      showToast(`üíæ Contr√¥le sauvegard√© localement pour ${employeNom}`);
                 } else {
                      showToast(`‚ùå Erreur: ${result.message}`);
                 }
            } catch (error) {
                 console.error("Erreur attrap√©e dans validerControle:", error);
                 showToast(`‚ùå Erreur: ${error.message}`);
            }
        }

        function updateQty(employeEmail, index, delta) {
            if (!controlesEnCours[employeEmail] || !controlesEnCours[employeEmail].produits) {
                console.warn("√âtat des produits non trouv√© pour", employeEmail);
                return;
            }
            const produits = controlesEnCours[employeEmail].produits;
            if (index >= 0 && index < produits.length) {
                produits[index].qt√© = Math.max(0, produits[index].qt√© + delta);
                document.getElementById(`qty-${employeEmail}-${index}`).textContent = produits[index].qt√©;
                // Mettre √† jour le localStorage
                localStorage.setItem('controlesEnCours_palettes', JSON.stringify(controlesEnCours));
            }
        }


      // ---------- GESTION DES NOTIFICATIONS (Employ√©) ----------
       function loadNotifications() {
            const list = document.getElementById('notificationsList');
            const noNotif = document.getElementById('noNotifications');
            list.innerHTML = '';

            // Filtrer les notifications pour l'employ√© courant et en attente
            const mesNotifs = notifications.filter(n =>
                n.employe === currentUser.email && n.statut === 'pending'
            );

            if (mesNotifs.length === 0) {
                noNotif.classList.remove('hidden');
                return;
            }
            noNotif.classList.add('hidden');

            mesNotifs.forEach(notif => {
                const item = document.createElement('div');
                item.className = 'border p-4 rounded-lg bg-blue-50';
                let produitsHtml = '';
                if (Array.isArray(notif.produits)) {
                    notif.produits.forEach(p => {
                        if (p && p.qt√© > 0) {
                            produitsHtml += `<div>${p.designation}: <strong>${p.qt√©}</strong></div>`;
                        }
                    });
                }

                item.innerHTML = `
                    <p class="text-sm text-gray-500">
                        Contr√¥le du ${formatDate(new Date(notif.date))} par ${notif.manager}
                    </p>
                    ${produitsHtml}
                    <div class="flex space-x-2 mt-4">
                        <button class="repondreControleBtn valideBtn flex-1 bg-green-600 text-white py-2 rounded text-sm"
                                data-notif-id="${notif.id}" data-reponse="valide">
                            ‚úÖ Je valide
                        </button>
                        <button class="repondreControleBtn recontroleBtn flex-1 bg-yellow-600 text-white py-2 rounded text-sm"
                                data-notif-id="${notif.id}" data-reponse="recontrole">
                            üîÑ Demander recontr√¥le
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });

            // Ajouter les √©couteurs d'√©v√©nements aux boutons de r√©ponse
            document.querySelectorAll('.repondreControleBtn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const notifId = event.target.dataset.notifId;
                    const reponse = event.target.dataset.reponse;
                    await repondreControle(notifId, reponse);
                });
            });
        }

        async function repondreControle(notifId, reponse) {
            const index = notifications.findIndex(n => n.id === notifId);
            if (index !== -1) {
                notifications[index].statut = 'done';
                notifications[index].reponseEmploye = reponse;
                localStorage.setItem('notifications_palettes', JSON.stringify(notifications));

                // Optionnel: Envoyer la r√©ponse au script GAS
                 const notifData = notifications[index];
                 const dataToSend = {
                     ...notifData,
                     action: 'reponse_employe',
                     reponse_employe: reponse
                 };
                 const result = await sendToGoogleScript(dataToSend);
                 if(result.status === 'success') {
                      console.log("R√©ponse de l'employ√© envoy√©e:", reponse);
                 } else {
                      console.warn("√âchec de l'envoi de la r√©ponse de l'employ√©:", result.message);
                 }

                loadNotifications(); // Recharger la liste
                showToast(`‚úÖ R√©ponse enregistr√©e`);
            }
        }


      // ---------- INITIALISATION ----------
      document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded - Initialisation des √©couteurs principaux");
        // Attacher les √©couteurs d'√©v√©nements principaux
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault(); // Emp√™che le rechargement de la page
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          console.log("Tentative de login pour:", email);
          const success = await login(email, password); // Attendre la fin du login/chargement
          if (!success) {
            console.log("Login √©chou√© pour:", email);
            document.getElementById('loginError').classList.remove('hidden');
          } else {
            console.log("Login r√©ussi pour:", email);
            document.getElementById('loginError').classList.add('hidden');
          }
        });

        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('logoutBtnEmploye').addEventListener('click', logout);
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        // Les √©couteurs pour les boutons dans le modal sont ajout√©s dynamiquement dans openControle
      });

    })(); // Fin de l'IIFE
  </script>
</body>
</html>
