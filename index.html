<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ContrÃ´les - Ouest Palettes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .status-badge { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
    .status-done { background-color: #10b981; }
    .status-pending { background-color: #f59e0b; }
    .status-new { background-color: #6b7280; }
    .qty-btn { width: 30px; height: 30px; font-size: 18px; font-weight: bold; }
    #managerApp, #employeApp, #modalControle, #loadingSpinner { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Ã‰cran de connexion -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen px-6">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
      <img src="https://i.ibb.co/6cRdDfrM/logo-ouest-palettes.png" alt="Ouest Palettes" class="w-40 h-12 mx-auto mb-4" />
      <p class="text-lg font-semibold text-blue-600 mb-6">ContrÃ´les de Production</p>
      <form id="loginForm" class="space-y-4">
        <input id="email" type="text" placeholder="Identifiant" class="w-full p-3 border border-gray-300 rounded-lg" required autocomplete="username" />
        <input id="password" type="password" placeholder="Mot de passe" class="w-full p-3 border border-gray-300 rounded-lg" required autocomplete="current-password" />
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold">Se connecter</button>
      </form>
      <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Identifiant ou mot de passe incorrect</p>
    </div>
  </div>

  <!-- Indicateur de chargement -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
     <div class="bg-white p-6 rounded-full shadow-lg">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-2 text-center">Chargement...</p>
     </div>
  </div>

  <!-- Application Manager -->
  <div id="managerApp">
    <header class="bg-white shadow-sm p-4">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">ðŸ“‹ ContrÃ´les â€” <span id="currentDate"></span></h1>
        <button id="logoutBtn" class="text-sm text-red-500">DÃ©connexion</button>
      </div>
    </header>
    <div class="flex-1 p-4 space-y-6 overflow-y-auto">
      <div class="bg-white p-5 rounded-xl shadow">
        <h2 class="font-semibold mb-4">Mes EmployÃ©s</h2>
        <div id="employesList" class="space-y-3"></div>
      </div>
    </div>
    <div id="offlineBar" class="hidden bg-yellow-500 text-white text-center py-2 text-sm">ðŸ“´ Hors ligne.</div>
  </div>

  <!-- Application EmployÃ© -->
  <div id="employeApp">
    <header class="bg-white shadow-sm p-4">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">ðŸ”” Notifications</h1>
        <button id="logoutBtnEmploye" class="text-sm text-red-500">DÃ©connexion</button>
      </div>
    </header>
    <div class="flex-1 p-4 space-y-6 overflow-y-auto">
      <div class="bg-white p-5 rounded-xl shadow">
        <h2 class="font-semibold mb-4">ContrÃ´les en attente</h2>
        <div id="notificationsList" class="space-y-3"></div>
        <p id="noNotifications" class="text-gray-500 text-center py-4 hidden">Aucun contrÃ´le en attente</p>
      </div>
    </div>
  </div>

  <!-- Modal Fiche ContrÃ´le -->
  <div id="modalControle" style="display: none;">
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 relative">
        <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
        <h2 class="text-xl font-bold mb-4">ðŸ“… <span id="modalDate"></span></h2>
        <h3 class="text-lg font-semibold mb-4">ðŸ‘¤ <span id="modalEmployeNom"></span></h3>
        <div id="produitsList" class="space-y-4 mb-6"></div>
        <div class="flex space-x-2">
          <button class="validerBtn flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold" data-attente="false">âœ… Valider sans confirmation</button>
          <button class="validerBtn flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold" data-attente="true">ðŸ”„ Valider et attendre confirmation</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 left-1/2 bg-black text-white px-4 py-2 rounded-lg text-sm hidden transform -translate-x-1/2 transition-opacity duration-300"></div>

  <script>
    (() => {
      console.log("=== Initialisation de l'application ===");
      const CONFIG = {
        managers: [
          { email: 'thierry', password: '1234', role: 'manager', equipe: 'Atelier Brest' },
          { email: 'johan', password: '1234', role: 'manager', equipe: 'Atelier Rennes' }
        ],
        // *** URL DU SCRIPT GOOGLE APPS ***
        urlScript: 'https://script.google.com/macros/s/AKfycbzdJ93EYEMEWM1QJQtSdLk82pFDzfsKpwcIK3YrEa97oB0Xt3rUCebmd12UCXOuP1mU/exec',
        delaiAutoValidation: 2 * 60 * 60 * 1000
      };

      let currentUser = null;
      let allUsers = [];
      let controlesEnCours = JSON.parse(localStorage.getItem('controlesEnCours_palettes') || '{}');
      let notifications = JSON.parse(localStorage.getItem('notifications_palettes') || '[]');
      let timers = JSON.parse(localStorage.getItem('timers_palettes') || '{}');

      function formatDate(date) {
        return new Intl.DateTimeFormat('fr-FR').format(date);
      }

      function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
      }

      function showLoading(show) {
          const spinner = document.getElementById('loadingSpinner');
          spinner.style.display = show ? 'flex' : 'none';
      }

      function checkOnlineStatus() {
        const bar = document.getElementById('offlineBar');
        const updateBar = () => bar?.classList.toggle('hidden', navigator.onLine);
        ['online', 'offline'].forEach(evt => window.addEventListener(evt, updateBar));
        updateBar();
      }

      async function sendToGoogleScript(data) {
        if (!navigator.onLine) {
            showToast('âš ï¸ Mode hors ligne.');
            return {status: 'offline', message: 'SauvegardÃ© localement'};
        }
        try {
            console.log("Envoi au script GAS:", data);
            const response = await fetch(CONFIG.urlScript, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const result = await response.json();
            console.log("RÃ©ponse du script GAS:", result);
            if (result.status !== 'success') throw new Error(result.message);
            return result;
        } catch (error) {
            console.error('Erreur envoi GAS:', error);
            showToast('âš ï¸ Erreur dâ€™envoi.');
            return {status: 'error', message: error.message};
        }
      }

      async function loadEmployesFromSheet() {
        showLoading(true);
        try {
            console.log("Chargement des employÃ©s via:", CONFIG.urlScript);
            const response = await fetch(CONFIG.urlScript);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const employesData = await response.json();
            console.log("EmployÃ©s reÃ§us:", employesData?.length || 0);
            
            if (employesData && employesData.status === 'error') {
                throw new Error(employesData.message);
            }
            
            const employes = Array.isArray(employesData) ? employesData.map(emp => ({
                email: emp.Email || emp.email || emp.EMAIL || '',
                password: '1234',
                role: 'employe',
                equipe: emp.Equipe || emp.equipe || emp['Equipe'] || '',
                manager: (emp.Equipe || emp.equipe || emp['Equipe']) === 'Atelier Brest' ? 'thierry' : 'johan'
            })) : [];
            
            allUsers = [...CONFIG.managers, ...employes];
            console.log("Utilisateurs chargÃ©s:", allUsers.length);
            loadEmployes();
        } catch (error) {
            console.error("Erreur chargement employÃ©s:", error);
            showToast("âŒ Erreur: " + error.message);
            allUsers = [...CONFIG.managers];
            loadEmployes();
        } finally {
            showLoading(false);
        }
      }

      async function login(email, password) {
        console.log("Tentative de login pour:", email);
        const user = allUsers.find(u => u.email === email && u.password === password);
        if (user) {
          currentUser = user;
          document.getElementById('loginScreen').style.display = 'none';
          if (user.role === 'manager') {
            document.getElementById('managerApp').style.display = 'flex';
            document.getElementById('currentDate').textContent = formatDate(new Date());
            await loadEmployesFromSheet();
          } else {
            document.getElementById('employeApp').style.display = 'flex';
            loadNotifications();
          }
          document.getElementById('modalDate').textContent = formatDate(new Date());
          checkOnlineStatus();
          return true;
        } else {
          return false;
        }
      }

      function logout() {
        console.log("DÃ©connexion de:", currentUser?.email);
        currentUser = null;
        allUsers = [];
        ['loginScreen', 'managerApp', 'employeApp', 'modalControle'].forEach(id => {
            document.getElementById(id).style.display = id === 'loginScreen' ? 'flex' : 'none';
        });
        document.getElementById('loginForm').reset();
        document.getElementById('loginError').classList.add('hidden');
        document.getElementById('employesList').innerHTML = '';
      }

      function loadEmployes() {
        const list = document.getElementById('employesList');
        list.innerHTML = '';
        const employesDuManager = allUsers.filter(u => u.role === 'employe' && u.manager === currentUser.email);
        if (employesDuManager.length === 0) {
            list.innerHTML = '<p class="text-gray-500">Aucun employÃ© trouvÃ©.</p>';
            return;
        }
        employesDuManager.forEach(emp => {
            let statut = 'new';
            if (controlesEnCours[emp.email]?.statut === 'pending') statut = 'pending';
            else if (controlesEnCours[emp.email]?.statut === 'done') statut = 'done';
            const displayName = emp.email.split('@')[0].split('.').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
            const item = document.createElement('div');
            item.className = 'border p-3 rounded-lg bg-gray-50 flex justify-between items-center';
            item.innerHTML = `
                <div><span class="status-badge status-${statut}"></span><span class="font-medium">${displayName}</span></div>
                <button class="openControleBtn bg-blue-600 text-white px-3 py-1 rounded text-sm" data-employe-email="${emp.email}">
                    ${statut === 'new' ? 'ContrÃ´ler' : 'Modifier'}
                </button>
            `;
            list.appendChild(item);
        });
        document.querySelectorAll('.openControleBtn').forEach(btn => {
            btn.addEventListener('click', (e) => openControle(e.target.dataset.employeEmail));
        });
      }

      function openControle(employeEmail) {
        console.log("Ouverture contrÃ´le pour:", employeEmail);
        const employe = allUsers.find(u => u.email === employeEmail);
        if (!employe) { showToast("Erreur: EmployÃ© non trouvÃ©."); return; }
        document.getElementById('modalEmployeNom').textContent = employe.email;
        const produits = controlesEnCours[employe.email]?.produits || [
            { designation: 'Palette EURO neuve', qtÃ©: 0 },
            { designation: 'Palette rÃ©parÃ©e H1', qtÃ©: 0 },
            { designation: 'Palette perdue', qtÃ©: 0 }
        ];
        const produitsList = document.getElementById('produitsList');
        produitsList.innerHTML = '';
        produits.forEach((prod, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg';
            div.innerHTML = `
                <span>${prod.designation}</span>
                <div class="flex items-center space-x-2">
                    <button class="qty-btn bg-gray-300 rounded decreaseQtyBtn" data-employe="${employeEmail}" data-index="${index}">-</button>
                    <span id="qty-${employeEmail}-${index}" class="font-bold w-12 text-center">${prod.qtÃ©}</span>
                    <button class="qty-btn bg-gray-300 rounded increaseQtyBtn" data-employe="${employeEmail}" data-index="${index}">+</button>
                </div>
            `;
            produitsList.appendChild(div);
        });
        if (!controlesEnCours[employeEmail]) controlesEnCours[employeEmail] = {};
        controlesEnCours[employeEmail].produits = produits;
        localStorage.setItem('controlesEnCours_palettes', JSON.stringify(controlesEnCours));
        document.getElementById('modalControle').style.display = 'block';
        ['.decreaseQtyBtn', '.increaseQtyBtn'].forEach(cls => {
            document.querySelectorAll(cls).forEach(btn => btn.addEventListener('click', handleQtyBtnClick));
        });
        document.querySelectorAll('.validerBtn').forEach(btn => btn.addEventListener('click', handleValiderBtnClick));
      }

      function closeModal() {
        document.getElementById('modalControle').style.display = 'none';
      }

      function handleQtyBtnClick(e) {
         const empEmail = e.target.dataset.employe;
         const idx = parseInt(e.target.dataset.index);
         const delta = e.target.classList.contains('increaseQtyBtn') ? 1 : -1;
         updateQty(empEmail, idx, delta);
      }

      async function handleValiderBtnClick(e) {
         const attente = e.target.dataset.attente === 'true';
         console.log("Bouton 'Valider' cliquÃ©. Attente:", attente);
         await validerControle(attente);
      }

      async function validerControle(attenteConfirmation) {
        console.log("validerControle appelÃ© avec:", attenteConfirmation);
        const employeNom = document.getElementById('modalEmployeNom').textContent;
        const employe = allUsers.find(u => u.email === employeNom);
        if (!employe) { showToast("Erreur: EmployÃ© non trouvÃ©."); return; }
        const produits = controlesEnCours[employe.email]?.produits;
        if (!produits || produits.length === 0) { alert('Aucun produit.'); return; }
        if (produits.reduce((sum, p) => sum + p.qtÃ©, 0) === 0) { alert('Saisir qtÃ©.'); return; }
        const controle = {
            manager: currentUser.email,
            employe: employe.email,
            produits: produits,
            date: new Date().toISOString(),
            statut: attenteConfirmation ? 'pending' : 'done',
            reponseEmploye: null,
            timestampValidation: Date.now()
        };
        controlesEnCours[employe.email] = controle;
        localStorage.setItem('controlesEnCours_palettes', JSON.stringify(controlesEnCours));
        if (attenteConfirmation) {
            const notif = { id: Date.now().toString(), ...controle };
            notifications.push(notif);
            localStorage.setItem('notifications_palettes', JSON.stringify(notifications));
        }
        showToast("Envoi en cours...");
        try {
             const result = await sendToGoogleScript(controle);
             if (result.status === 'success') {
                 closeModal();
                 loadEmployes();
                 showToast(`âœ… EnregistrÃ© pour ${employeNom}`);
             } else {
                 showToast(`âŒ Erreur: ${result.message}`);
             }
        } catch (error) {
             console.error("Erreur dans validerControle:", error);
             showToast(`âŒ Erreur: ${error.message}`);
        }
      }

      function updateQty(employeEmail, index, delta) {
        if (!controlesEnCours[employeEmail]?.produits) return;
        const produits = controlesEnCours[employeEmail].produits;
        if (index >= 0 && index < produits.length) {
            produits[index].qtÃ© = Math.max(0, produits[index].qtÃ© + delta);
            document.getElementById(`qty-${employeEmail}-${index}`).textContent = produits[index].qtÃ©;
            localStorage.setItem('controlesEnCours_palettes', JSON.stringify(controlesEnCours));
        }
      }

      function loadNotifications() {
        const list = document.getElementById('notificationsList');
        const noNotif = document.getElementById('noNotifications');
        list.innerHTML = '';
        const mesNotifs = notifications.filter(n => n.employe === currentUser.email && n.statut === 'pending');
        if (mesNotifs.length === 0) {
            noNotif.classList.remove('hidden');
            return;
        }
        noNotif.classList.add('hidden');
        mesNotifs.forEach(notif => {
            const item = document.createElement('div');
            item.className = 'border p-4 rounded-lg bg-blue-50';
            let produitsHtml = '';
            if (Array.isArray(notif.produits)) {
                notif.produits.forEach(p => {
                    if (p && p.qtÃ© > 0) {
                        produitsHtml += `<div>${p.designation}: <strong>${p.qtÃ©}</strong></div>`;
                    }
                });
            }
            item.innerHTML = `
                <p class="text-sm text-gray-500">ContrÃ´le du ${formatDate(new Date(notif.date))} par ${notif.manager}</p>
                ${produitsHtml}
                <div class="flex space-x-2 mt-4">
                    <button class="repondreControleBtn valideBtn flex-1 bg-green-600 text-white py-2 rounded text-sm"
                            data-notif-id="${notif.id}" data-reponse="valide">âœ… Je valide</button>
                    <button class="repondreControleBtn recontroleBtn flex-1 bg-yellow-600 text-white py-2 rounded text-sm"
                            data-notif-id="${notif.id}" data-reponse="recontrole">ðŸ”„ Demander recontrÃ´le</button>
                </div>
            `;
            list.appendChild(item);
        });
        document.querySelectorAll('.repondreControleBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = e.target.dataset.notifId;
                const rep = e.target.dataset.reponse;
                const index = notifications.findIndex(n => n.id === id);
                if (index !== -1) {
                    notifications[index].statut = 'done';
                    notifications[index].reponseEmploye = rep;
                    localStorage.setItem('notifications_palettes', JSON.stringify(notifications));
                    await sendToGoogleScript({...notifications[index], action: 'reponse_employe', reponse_employe: rep});
                    loadNotifications();
                    showToast(`âœ… RÃ©ponse enregistrÃ©e`);
                }
            });
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        console.log("=== DOMContentLoaded ===");
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          console.log("Formulaire de login soumis:", email);
          const success = await login(email, password);
          document.getElementById('loginError').classList.toggle('hidden', success);
        });
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('logoutBtnEmploye').addEventListener('click', logout);
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
      });
      console.log("=== Fin de l'IIFE ===");
    })();
  </script>
</body>
</html>
